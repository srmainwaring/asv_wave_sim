<?xml version="1.0" ?>
<sdf version="1.7">
  <model name="havyard">

    <link name="base_link">
      <visual name="hull">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/hull.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <visual name="hull_anchors">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/hull_anchors.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <visual name="hull_fittings">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/hull_fittings.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <visual name="main_deck">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/main_deck.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <visual name="main_deck_sides">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/main_deck_sides.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <visual name="a_deck">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/a_deck.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <visual name="b_deck">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/b_deck.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <visual name="c_deck">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/c_deck.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <visual name="wheelhouse_roof">
        <geometry>
          <mesh>
            <scale>50 50 50</scale>
            <uri>meshes/wheelhouse_roof.dae</uri>
          </mesh>
        </geometry>
      </visual>

      <!-- Leave axes visuals for debugging -->
      <!--
      <visual name="base_x_axis">
        <pose>25 0 0 0 0 0</pose>
        <geometry>
          <box>
            <size>50 0.1 0.1</size>
          </box>
        </geometry>
        <material>
          <ambient>1.0 0.0 0.0 1.0</ambient>
          <diffuse>1.0 0.0 0.0 1.0</diffuse>
          <specular>0.8 0.8 0.8 1.0</specular>
        </material>
      </visual>
      <visual name="base_y_axis">
        <pose>0 10 0 0 0 0</pose>
        <geometry>
          <box>
            <size>0.1 20 0.1</size>
          </box>
        </geometry>
        <material>
          <ambient>0.0 1.0 0.0 1.0</ambient>
          <diffuse>0.0 1.0 0.0 1.0</diffuse>
          <specular>0.8 0.8 0.8 1.0</specular>
        </material>
      </visual>
      <visual name="base_z_axis">
        <pose>0 0 10 0 0 0</pose>
        <geometry>
          <box>
            <size>0.1 0.1 20</size>
          </box>
        </geometry>
        <material>
          <ambient>0.0 0.0 1.0 1.0</ambient>
          <diffuse>0.0 0.0 1.0 1.0</diffuse>
          <specular>0.8 0.8 0.8 1.0</specular>
        </material>
      </visual>
      -->

      <collision name="hull_collision">
        <geometry>
          <mesh>
            <uri>meshes/hull_collision_x50.stl</uri>
          </mesh>
        </geometry>
      </collision>

      <inertial>
        <pose>0 0 -0.5 0 0 0</pose>
        <mass>3850000</mass>
        <inertia>
          <ixx>194548849</ixx>
          <ixy>0.0</ixy>
          <ixz>0.0</ixz>
          <iyy>2210809763</iyy>
          <iyz>0.0</iyz>
          <izz>2235396753</izz>
        </inertia>
      </inertial>
    </link>

    <!-- Engines -->
    <link name="left_engine_link">
      <pose>-30 5 -5 0 0 0</pose>
      <visual name="visual">
        <pose>0 0 0 0 1.570796 0</pose>
        <geometry>
          <cylinder>
            <length>1</length>
            <radius>0.5</radius>
          </cylinder>
        </geometry>
      </visual>
      <collision name="collision">
        <pose>0 0 0 0 1.570796 0</pose>
        <geometry>
          <cylinder>
            <length>1</length>
            <radius>0.5</radius>
          </cylinder>
        </geometry>
      </collision>
      <inertial>
        <mass>960</mass>
        <inertia>
          <ixx>56.91136</ixx>
          <ixy>0</ixy>
          <iyy>58.312</iyy>
          <iyz>0</iyz>
          <izz>5</izz>
        </inertia>
      </inertial>
    </link>
    <joint name="left_engine_joint" type="revolute">
      <parent>base_link</parent>
      <child>left_engine_link</child>
      <axis>
        <xyz>0 0 1</xyz>
        <limit>
          <lower>-0.7853981633974483</lower>
          <upper>0.7853981633974483</upper>
        </limit>
        <dynamics>
          <damping>0.1</damping>
        </dynamics>
      </axis>
    </joint>

    <link name="right_engine_link">
      <pose>-30 -5 -5 0 0 0</pose>
      <visual name="visual">
        <pose>0 0 0 0 1.570796 0</pose>
        <geometry>
          <cylinder>
            <length>1</length>
            <radius>0.5</radius>
          </cylinder>
        </geometry>
      </visual>
      <collision name="collision">
        <pose>0 0 0 0 1.570796 0</pose>
        <geometry>
          <cylinder>
            <length>1</length>
            <radius>0.5</radius>
          </cylinder>
        </geometry>
      </collision>
      <inertial>
        <mass>960</mass>
        <inertia>
          <ixx>56.91136</ixx>
          <ixy>0</ixy>
          <iyy>58.312</iyy>
          <iyz>0</iyz>
          <izz>5</izz>
        </inertia>
      </inertial>
    </link>
    <joint name="right_engine_joint" type="revolute">
      <parent>base_link</parent>
      <child>right_engine_link</child>
      <axis>
        <xyz>0 0 1</xyz>
        <limit>
          <lower>-0.7853981633974483</lower>
          <upper>0.7853981633974483</upper>
        </limit>
        <dynamics>
          <damping>0.1</damping>
        </dynamics>
      </axis>
    </joint>

    <link name="left_propeller_link">
      <pose relative_to="left_propeller_joint">-0.5 0 0 0 0 0</pose>
      <visual name="visual">
        <geometry>
          <mesh>
            <scale>4 4 4</scale>
            <uri>meshes/propeller.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <collision name="collision">
        <pose>0 0 0 0 1.570796 0</pose>
        <geometry>
          <cylinder>
            <length>0.72</length>
            <radius>0.96</radius>
          </cylinder>
        </geometry>
      </collision>
      <inertial>
        <mass>32</mass>
        <inertia>
          <ixx>0.54688</ixx>
          <ixy>0</ixy>
          <iyy>0.54688</iyy>
          <iyz>0</iyz>
          <izz>0.9216</izz>
        </inertia>
      </inertial>
    </link>
    <joint name="left_propeller_joint" type="revolute">
      <pose relative_to="left_engine_link">0 0 0 0 0 0</pose>
      <parent>left_engine_link</parent>
      <child>left_propeller_link</child>
      <axis>
        <xyz>1 0 0</xyz>
        <dynamics>
          <damping>0.01</damping>
        </dynamics>
        <limit>
          <lower>-1e+16</lower>
          <upper>1e+16</upper>
        </limit>
      </axis>
    </joint>

    <link name="right_propeller_link">
      <pose relative_to="right_propeller_joint">-0.5 0 0 0 0 0</pose>
      <visual name="visual">
        <geometry>
          <mesh>
            <scale>4 4 4</scale>
            <uri>meshes/propeller.dae</uri>
          </mesh>
        </geometry>
      </visual>
      <collision name="collision">
        <pose>0 0 0 0 1.570796 0</pose>
        <geometry>
          <cylinder>
            <length>0.72</length>
            <radius>0.96</radius>
          </cylinder>
        </geometry>
      </collision>
      <inertial>
        <mass>32</mass>
        <inertia>
          <ixx>0.54688</ixx>
          <ixy>0</ixy>
          <iyy>0.54688</iyy>
          <iyz>0</iyz>
          <izz>0.9216</izz>
        </inertia>
      </inertial>
    </link>
    <joint name="right_propeller_joint" type="revolute">
      <pose relative_to="right_engine_link">0 0 0 0 0 0</pose>
      <parent>right_engine_link</parent>
      <child>right_propeller_link</child>
      <axis>
        <xyz>1 0 0</xyz>
        <dynamics>
          <damping>0.01</damping>
        </dynamics>
        <limit>
          <lower>-1e+16</lower>
          <upper>1e+16</upper>
        </limit>
      </axis>
    </joint>

    <!-- Sensors -->
    <link name="imu_link">
      <inertial>
        <pose>0 0 0 0 0 0</pose>
        <mass>0.15</mass>
        <inertia>
          <ixx>0.00001</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.00002</iyy>
          <iyz>0</iyz>
          <izz>0.00002</izz>
        </inertia>
      </inertial>
      <sensor name="imu_sensor" type="imu">
        <pose>0 0 0 3.141593 0 0</pose>
        <always_on>1</always_on>
        <update_rate>1000.0</update_rate>
      </sensor>
    </link>
    <joint name="imu_joint" type="revolute">
      <child>imu_link</child>
      <parent>base_link</parent>
      <axis>
        <xyz>0 0 1</xyz>
        <limit>
          <lower>0</lower>
          <upper>0</upper>
          <effort>0</effort>
          <velocity>0</velocity>
        </limit>
        <dynamics>
          <damping>1.0</damping>
        </dynamics>
      </axis>
    </joint>

    <!-- Joint state and force plugins -->
    <plugin filename="gz-sim-joint-state-publisher-system"
      name="gz::sim::systems::JointStatePublisher">
    </plugin>
    <plugin filename="gz-sim-apply-joint-force-system"
      name="gz::sim::systems::ApplyJointForce">
      <joint_name>left_engine_joint</joint_name>
    </plugin>
    <plugin filename="gz-sim-apply-joint-force-system"
      name="gz::sim::systems::ApplyJointForce">
      <joint_name>right_engine_joint</joint_name>
    </plugin>

    <!-- Thruster plugins -->
    <plugin
        filename="gz-sim-thruster-system"
        name="gz::sim::systems::Thruster">
      <namespace>wam-v</namespace>
      <joint_name>left_propeller_joint</joint_name>
      <use_angvel_cmd>0</use_angvel_cmd>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>1.92</propeller_diameter>
      <thrust_coefficient>-0.5</thrust_coefficient>
      <velocity_control>1</velocity_control>
      <max_thrust_cmd>2000000.0</max_thrust_cmd>
      <min_thrust_cmd>-2000000.0</min_thrust_cmd>
    </plugin>
    <plugin
        filename="gz-sim-thruster-system"
        name="gz::sim::systems::Thruster">
      <namespace>wam-v</namespace>
      <joint_name>right_propeller_joint</joint_name>
      <use_angvel_cmd>0</use_angvel_cmd>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>1.92</propeller_diameter>
      <thrust_coefficient>0.5</thrust_coefficient>
      <velocity_control>1</velocity_control>
      <max_thrust_cmd>2000000.0</max_thrust_cmd>
      <min_thrust_cmd>-2000000.0</min_thrust_cmd>
    </plugin>

    <!-- Hydrodynamics plugin -->
    <plugin
      filename="gz-waves1-hydrodynamics-system"
      name="gz::sim::systems::Hydrodynamics">
      <damping_on>1</damping_on>
      <viscous_drag_on>1</viscous_drag_on>
      <pressure_drag_on>1</pressure_drag_on>
      <cDampL1>1.0E-3</cDampL1>
      <cDampL2>1.0E-3</cDampL2>
      <cDampR1>1.0E+7</cDampR1>
      <cDampR2>1.0E+7</cDampR2>
      <cPDrag1>1.0E+2</cPDrag1>
      <cPDrag2>1.0E+2</cPDrag2>
      <fPDrag>0.4</fPDrag>
      <cSDrag1>1.0E+2</cSDrag1>
      <cSDrag2>1.0E+2</cSDrag2>
      <fSDrag>0.4</fSDrag>
      <vRDrag>1.0</vRDrag>
    </plugin>

    <!-- ArduPilot plugin -->
    <plugin name="ArduPilotPlugin" filename="libArduPilotPlugin.so">
      <fdm_addr>127.0.0.1</fdm_addr>
      <fdm_port_in>9012</fdm_port_in>
      <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>
      <lock_step>1</lock_step>
      <modelXYZToAirplaneXForwardZDown>0 0 0 3.141593 0 0</modelXYZToAirplaneXForwardZDown>
      <gazeboXYZToNED>0 0 0 3.141593 0 0</gazeboXYZToNED>
      <imuName>imu_sensor</imuName>

      <!--
        SERVO1_FUNCTION 26 (GroundSteering)
      -->
      <control channel="0">
        <jointName>left_engine_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.5707963267948966</multiplier>
        <offset>-0.5</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>POSITION</type>
        <p_gain>200000.0</p_gain>
        <i_gain>0</i_gain>
        <d_gain>100</d_gain>
        <i_max>-1</i_max>
        <i_min>0</i_min>
        <cmd_max>1000000.0</cmd_max>
        <cmd_min>-1000000.0</cmd_min>
      </control>
      <control channel="0">
        <jointName>right_engine_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.5707963267948966</multiplier>
        <offset>-0.5</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>POSITION</type>
        <p_gain>200000.0</p_gain>
        <i_gain>0</i_gain>
        <d_gain>100</d_gain>
        <i_max>-1</i_max>
        <i_min>0</i_min>
        <cmd_max>1000000.0</cmd_max>
        <cmd_min>-1000000.0</cmd_min>
      </control>

      <!--
        SERVO3_FUNCTION 70 (Throttle)
      -->
      <control channel="2">
        <jointName>left_propeller_joint</jointName>
        <useForce>1</useForce>
        <multiplier>2000000</multiplier>
        <offset>-0.5</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/wam-v/joint/left_propeller_joint/cmd_thrust</cmd_topic>
      </control>
      <control channel="2">
        <jointName>right_propeller_joint</jointName>
        <useForce>1</useForce>
        <multiplier>2000000</multiplier>
        <offset>-0.5</offset>
        <servo_min>1000</servo_min>
        <servo_max>2000</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/wam-v/joint/right_propeller_joint/cmd_thrust</cmd_topic>
      </control>
    </plugin>

  </model>
</sdf>
